@page "/inventory/transactions"

@using warehouseapp.ViewModels.Inventory
@using warehouseapp.Enums
@inject HttpClient Http

<h2 class="page-title mb-4">Inventory Transactions</h2>

<div class="inventory-card card">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th>Date</th>
                <th>Product</th>
                <th>Movement</th>
                <th class="text-end">Qty</th>
                <th>Partner</th>
                <th>Batch</th>
                <th>Expiration</th>
            </tr>
        </thead>

        <tbody>
            @if (transactions == null)
            {
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        Loading…
                    </td>
                </tr>
            }
            else if (!transactions.Any())
            {
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        No transactions found
                    </td>
                </tr>
            }
            else
            {
                @foreach (var t in transactions)
                {
                    <tr class="@(t.Source == InventoryTransactionSourceEnum.SalesReturn ? "return-row" : "")">
                        <td>
                            @(t.CompletedAt?.ToString("dd MMM yyyy")
                              ?? t.CreatedAt.ToString("dd MMM yyyy"))
                        </td>

                        <td>@t.ProductName</td>

                        <td>
                            @if (t.Source == InventoryTransactionSourceEnum.SalesReturn)
                            {
                                <span class="inventory-pill return">⤺ Returned</span>
                                @if (t.ReturnReason.HasValue)
                                {
                                    <div class="mt-1">
                                        <span class="inventory-pill reason">
                                            Reason: @t.ReturnReason
                                        </span>
                                    </div>
                                }
                            }
                            else if (t.TransactionType == TransactionTypeEnum.In)
                            {
                                <span class="inventory-pill in">⬇ Stock In</span>
                            }
                            else
                            {
                                <span class="inventory-pill out">⬆ Stock Out</span>
                            }
                        </td>

                        <td class="text-end fw-semibold">@t.Quantity</td>
                        <td>@t.PartnerName</td>

                        <td>
                            @if (!string.IsNullOrWhiteSpace(t.BatchNumber))
                            {
                                <span class="inventory-pill batch">@t.BatchNumber</span>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>

                        <td>
                            @if (t.ExpirationDate.HasValue)
                            {
                                @t.ExpirationDate.Value.ToString("dd MMM yyyy")
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<InventoryTransactionResponseViewModel>? transactions;

    protected override async Task OnInitializedAsync()
    {
        transactions =
            await Http.GetFromJsonAsync<List<InventoryTransactionResponseViewModel>>(
                "api/inventory/transactions");
    }
}
